name: GoReleaser

# GoReleaser should run when release-please creates a new release.
# Note: release-please creates tags via GitHub API, not git push,
# so we trigger on the release event instead of push to tags.
on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v0.1.0)'
        required: true
        type: string

permissions:
  contents: write # Needed for GoReleaser to upload artifacts to the release

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the code at the tag
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ inputs.tag || github.event.release.tag_name }}

      # 2. Setup Go
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache: false # Disable cache - we clean between regions to save disk

      # 3. Install GoReleaser
      - name: Install GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          install-only: true

      # 4. Generate region configs
      - name: Generate region configs
        run: |
          echo "Generating embed files and GoReleaser config from regions.yaml..."
          make generate-embeds
          make generate-goreleaser

      # 5. Verify regions
      - name: Verify regions
        run: make verify-regions

      # 6. Build all regions sequentially (one at a time to save disk)
      - name: Build all regions
        run: |
          # Build one region at a time: generate pricing → build → clean cache
          # This keeps disk usage constant (~200MB) regardless of region count
          REGIONS=$(sed -n 's/^ *name: //p' internal/pricing/regions.yaml | tr '\n' ' ' | xargs)

          for region in $REGIONS; do
            echo ""
            echo "=============================================="
            echo "Building region: $region"
            echo "=============================================="
            df -h / | tail -1

            bash ./scripts/release-region.sh "$region"

            echo "Disk after $region:"
            df -h / | tail -1
          done

      # 7. Generate checksums for all archives
      - name: Generate checksums
        run: |
          cd dist
          sha256sum ./*.tar.gz ./*.zip > checksums.txt
          cat checksums.txt

      # 8. Upload release assets
      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ inputs.tag || github.event.release.tag_name }}"
          echo "Uploading assets to release $TAG..."
          gh release upload "$TAG" dist/*.tar.gz dist/*.zip dist/checksums.txt --clobber
