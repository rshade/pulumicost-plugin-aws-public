# Data Model: Embed Raw AWS Pricing JSON Per Service

**Feature**: 018-raw-pricing-embed
**Date**: 2025-12-20

## Overview

This document defines the data entities for per-service AWS pricing embedding.
The key insight is that the existing `awsPricing` struct already matches AWS API format exactly.

## Entities

### 1. AWS Pricing Response (awsPricing)

**Purpose**: Represents the raw JSON response from AWS Price List API for a single service.

**Definition**: Already exists in `internal/pricing/types.go` - no changes needed.

```go
type awsPricing struct {
    FormatVersion   string                                `json:"formatVersion"`
    Disclaimer      string                                `json:"disclaimer"`
    OfferCode       string                                `json:"offerCode"`       // Service identifier
    Version         string                                `json:"version"`         // AWS version timestamp
    PublicationDate string                                `json:"publicationDate"` // When AWS published
    Products        map[string]product                    `json:"products"`        // SKU → product
    Terms           map[string]map[string]map[string]term `json:"terms"`           // Type→SKU→Code→Term
}
```

**Validation Rules**:

- `OfferCode` MUST match expected service (e.g., "AmazonEC2", "AWSELB")
- `Products` map MUST NOT be empty
- `Terms["OnDemand"]` MUST exist for pricing lookups

### 2. Service Pricing File

**Purpose**: Raw JSON file embedded in binary, one per service per region.

**Naming**: `{service}_{region}.json` where service is lowercase abbreviation.

**State**: Immutable after generation (embedded at build time).

**Relationships**:

- Each file contains exactly one `awsPricing` struct
- Multiple files are embedded into one region binary
- Files are generated by `tools/generate-pricing`

**Validation Rules**:

| Service | File Pattern | Minimum Size |
|---------|--------------|--------------|
| EC2 | `ec2_{region}.json` | 100MB |
| RDS | `rds_{region}.json` | 10MB |
| EKS | `eks_{region}.json` | 2MB |
| Lambda | `lambda_{region}.json` | 1MB |
| S3 | `s3_{region}.json` | 500KB |
| DynamoDB | `dynamodb_{region}.json` | 400KB |
| ELB | `elb_{region}.json` | 400KB |

### 3. Embed Registry Variables

**Purpose**: Go package-level variables holding embedded pricing data.

**Definition**: One variable per service in each region-tagged embed file.

```go
// internal/pricing/embed_use1.go
//go:build region_use1

package pricing

import _ "embed"

//go:embed data/ec2_us-east-1.json
var rawEC2JSON []byte

//go:embed data/s3_us-east-1.json
var rawS3JSON []byte

//go:embed data/rds_us-east-1.json
var rawRDSJSON []byte

//go:embed data/eks_us-east-1.json
var rawEKSJSON []byte

//go:embed data/lambda_us-east-1.json
var rawLambdaJSON []byte

//go:embed data/dynamodb_us-east-1.json
var rawDynamoDBJSON []byte

//go:embed data/elb_us-east-1.json
var rawELBJSON []byte
```

**Lifecycle**:

1. Generated at build time by `tools/generate-pricing`
2. Embedded into binary via `go build -tags=region_use1`
3. Parsed once on first `Client` initialization via `sync.Once`
4. Indexed into in-memory maps for fast lookups

### 4. Service Index Maps (Existing)

**Purpose**: In-memory lookup structures built from parsed pricing data.

**Definition**: Already exists in `internal/pricing/client.go` - no changes to structure.

```go
type Client struct {
    // Indexes built from embedded data
    ec2Index        map[string]ec2Price
    ebsIndex        map[string]ebsPrice
    s3Index         map[string]s3Price
    rdsInstanceIndex map[string]rdsInstancePrice
    rdsStorageIndex  map[string]rdsStoragePrice
    eksPricing      *eksPrice
    lambdaPricing   *lambdaPrice
    dynamoDBPricing *dynamoDBPrice
    elbPricing      *elbPrice
}
```

**Changes Required**: `init()` method must parse each service file separately
instead of parsing a single combined file.

## Entity Relationships

```text
┌─────────────────────┐
│ tools/generate-     │
│ pricing/main.go     │
└─────────┬───────────┘
          │ fetches & writes
          ▼
┌─────────────────────┐     ┌─────────────────────┐
│ Service Pricing     │ ◄───│ AWS Price List API  │
│ Files (7 per region)│     │ (external)          │
└─────────┬───────────┘     └─────────────────────┘
          │ embedded via //go:embed
          ▼
┌─────────────────────┐
│ Embed Registry      │
│ Variables           │
│ (rawEC2JSON, etc.)  │
└─────────┬───────────┘
          │ parsed in init()
          ▼
┌─────────────────────┐
│ awsPricing struct   │
│ (per service)       │
└─────────┬───────────┘
          │ indexed into
          ▼
┌─────────────────────┐
│ Service Index Maps  │
│ (ec2Index, etc.)    │
└─────────┬───────────┘
          │ used by
          ▼
┌─────────────────────┐
│ PricingClient       │
│ Interface Methods   │
└─────────────────────┘
```

## Data Integrity

### Build-Time Validation

1. **Size thresholds**: `embed_test.go` verifies each embedded file meets minimum size
2. **Metadata validation**: Tests verify `offerCode` matches expected service
3. **Parsing validation**: Tests verify JSON unmarshals without error

### Runtime Validation

1. **Init failure**: `Client.init()` returns error if any service file fails to parse
2. **Lookup miss**: Pricing methods return `(0, false)` if SKU not found
3. **Thread safety**: `sync.Once` ensures single initialization

## Migration Notes

### Before (Current)

- Single `rawPricingJSON []byte` variable
- Single combined file: `aws_pricing_{region}.json`
- Synthetic `offerCode: "Combined"`

### After (Proposed)

- Seven `raw{Service}JSON []byte` variables
- Seven separate files: `{service}_{region}.json`
- Real AWS `offerCode` values preserved

### Breaking Changes

None. The `PricingClient` interface is unchanged. All existing methods continue
to work with the same signatures.
