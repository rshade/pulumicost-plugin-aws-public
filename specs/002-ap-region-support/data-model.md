# Data Model: Asia Pacific Region Support

**Feature**: 002-ap-region-support
**Date**: 2025-11-18
**Phase**: Phase 1 - Design & Contracts

## Overview

This document describes the data entities and relationships for Asia Pacific region support. Since the feature extends existing infrastructure without introducing new Go types, this focuses on configuration entities and relationships.

## Core Entities

### Region Mapping

Defines the relationship between AWS region identifiers, build tags, binary names, and geographic locations.

**Attributes**:

- **aws_region_id** (string): Official AWS region identifier (e.g., "ap-southeast-1")
- **build_tag** (string): Go build constraint tag (e.g., "region_apse1")
- **binary_name** (string): Output binary filename (e.g., "finfocus-plugin-aws-public-ap-southeast-1")
- **city_name** (string): Human-readable location (e.g., "Singapore")
- **geographic_area** (string): Geographic grouping (e.g., "Asia Pacific")

**Instances** (AP Regions):

| aws_region_id | build_tag | binary_name | city_name | geographic_area |
|---------------|-----------|-------------|-----------|-----------------|
| ap-southeast-1 | region_apse1 | finfocus-plugin-aws-public-ap-southeast-1 | Singapore | Asia Pacific |
| ap-southeast-2 | region_apse2 | finfocus-plugin-aws-public-ap-southeast-2 | Sydney | Asia Pacific |
| ap-northeast-1 | region_apne1 | finfocus-plugin-aws-public-ap-northeast-1 | Tokyo | Asia Pacific |
| ap-south-1 | region_aps1 | finfocus-plugin-aws-public-ap-south-1 | Mumbai | Asia Pacific |

**Validation Rules**:

- `aws_region_id` MUST match AWS official region naming convention
- `build_tag` MUST follow `region_<4char>` pattern
- `build_tag` MUST be unique across all regions
- `binary_name` MUST follow `finfocus-plugin-aws-public-<aws_region_id>` pattern

**Relationships**:

- Region Mapping → (1:1) → Pricing Data File
- Region Mapping → (1:1) → Embed File
- Region Mapping → (1:1) → GoReleaser Build Configuration

### Pricing Data File

Contains AWS public pricing information for a specific region, embedded at compile time.

**Attributes**:

- **filename** (string): JSON file path (e.g., "internal/pricing/data/aws_pricing_ap-southeast-1.json")
- **region** (string): AWS region identifier matching Region Mapping
- **currency** (string): Pricing currency (always "USD" for v1)
- **ec2_prices** (map): Instance type → pricing details
- **ebs_prices** (map): Volume type → pricing details

**JSON Schema** (unchanged from existing regions):

```json
{
  "region": "string",
  "currency": "USD",
  "ec2": {
    "<instance_type>": {
      "instance_type": "string",
      "operating_system": "Linux",
      "tenancy": "Shared",
      "hourly_rate": number
    }
  },
  "ebs": {
    "<volume_type>": {
      "volume_type": "string",
      "rate_per_gb_month": number
    }
  }
}
```

**Example Instance** (ap-southeast-1):

```json
{
  "region": "ap-southeast-1",
  "currency": "USD",
  "ec2": {
    "t3.micro": {
      "instance_type": "t3.micro",
      "operating_system": "Linux",
      "tenancy": "Shared",
      "hourly_rate": 0.0116
    },
    "m5.large": {
      "instance_type": "m5.large",
      "operating_system": "Linux",
      "tenancy": "Shared",
      "hourly_rate": 0.112
    }
  },
  "ebs": {
    "gp3": {
      "volume_type": "gp3",
      "rate_per_gb_month": 0.088
    },
    "gp2": {
      "volume_type": "gp2",
      "rate_per_gb_month": 0.11
    },
    "io2": {
      "volume_type": "io2",
      "rate_per_gb_month": 0.138
    }
  }
}
```

**Validation Rules**:

- `region` field MUST match filename region identifier
- `currency` MUST be "USD"
- `ec2` and `ebs` sections MUST be present (can be empty maps)
- Hourly rates and GB-month rates MUST be positive numbers
- Instance types and volume types MUST match AWS official naming

**Lifecycle**:

1. Generated by `tools/generate-pricing` (with `--dummy` flag for development)
2. Embedded into binary via `go:embed` directive
3. Parsed once at plugin startup with `sync.Once`
4. Indexed for O(1) lookup during gRPC calls

### Embed File

Go source file that embeds a Pricing Data File into the binary using build tags.

**Attributes**:

- **filename** (string): Go source file (e.g., "internal/pricing/embed_apse1.go")
- **build_tag** (string): Build constraint from Region Mapping
- **embedded_file** (string): Relative path to Pricing Data File

**Template Structure**:

```go
//go:build <build_tag>

package pricing

import _ "embed"

//go:embed data/aws_pricing_<region>.json
var rawPricingJSON []byte
```

**Instances** (AP Regions):

| filename | build_tag | embedded_file |
|----------|-----------|---------------|
| internal/pricing/embed_apse1.go | region_apse1 | data/aws_pricing_ap-southeast-1.json |
| internal/pricing/embed_apse2.go | region_apse2 | data/aws_pricing_ap-southeast-2.json |
| internal/pricing/embed_apne1.go | region_apne1 | data/aws_pricing_ap-northeast-1.json |
| internal/pricing/embed_aps1.go | region_aps1 | data/aws_pricing_ap-south-1.json |

**Build-Time Behavior**:

- When building with `-tags <build_tag>`, exactly ONE embed file is selected
- Selected embed file's `rawPricingJSON` is compiled into the binary
- Other embed files are excluded by the build system
- Fallback embed file (`embed_fallback.go`) is excluded when ANY region tag is present

**Validation Rules**:

- Build tag MUST match Region Mapping
- Embedded file path MUST be relative to package directory
- Embedded file MUST exist at build time
- Package variable name MUST be `rawPricingJSON` (referenced by client.go)

### GoReleaser Build Configuration

Defines how to build a region-specific binary with GoReleaser.

**Attributes**:

- **id** (string): Build identifier (e.g., "ap-southeast-1")
- **binary** (string): Output binary name from Region Mapping
- **tags** (list): Build tags (single tag from Region Mapping)
- **goos** (list): Target operating systems ["linux", "darwin", "windows"]
- **goarch** (list): Target architectures ["amd64", "arm64"]

**YAML Template**:

```yaml
- id: <region_id>
  main: ./cmd/finfocus-plugin-aws-public
  binary: <binary_name>
  env:
    - CGO_ENABLED=0
  goos:
    - linux
    - darwin
    - windows
  goarch:
    - amd64
    - arm64
  tags:
    - <build_tag>
  ldflags:
    - -s -w -X main.version={{.Version}}
```

**Instances** (AP Regions):

| id | binary | tags | platforms |
|----|--------|------|-----------|
| ap-southeast-1 | finfocus-plugin-aws-public-ap-southeast-1 | [region_apse1] | 6 (3 OS × 2 arch) |
| ap-southeast-2 | finfocus-plugin-aws-public-ap-southeast-2 | [region_apse2] | 6 (3 OS × 2 arch) |
| ap-northeast-1 | finfocus-plugin-aws-public-ap-northeast-1 | [region_apne1] | 6 (3 OS × 2 arch) |
| ap-south-1 | finfocus-plugin-aws-public-ap-south-1 | [region_aps1] | 6 (3 OS × 2 arch) |

**Build Matrix**:

- **Per-region artifacts**: 6 (linux-amd64, linux-arm64, darwin-amd64, darwin-arm64, windows-amd64, windows-arm64)
- **Total AP artifacts**: 24 (4 regions × 6 platforms)
- **Total all regions**: 42 (7 regions × 6 platforms)

## Entity Relationships

```text
Region Mapping
    ├── aws_region_id ────────────┐
    ├── build_tag ────┐           │
    └── binary_name ──┼──┐        │
                      │  │        │
                      ▼  ▼        ▼
    Embed File    GoReleaser   Pricing Data File
        │            Build         │
        │         Configuration    │
        │                          │
        └──────── embeds ──────────┘
                      │
                      ▼
                  Binary
                  (runtime)
                      │
                      ▼
                gRPC Service
                  (serves)
```

### Relationship Details

1. **Region Mapping → Pricing Data File** (1:1)
   - One region mapping defines exactly one pricing data file
   - Filename derived from `aws_pricing_<aws_region_id>.json`

2. **Region Mapping → Embed File** (1:1)
   - One region mapping defines exactly one embed file
   - Filename derived from `embed_<build_tag_suffix>.go`
   - Build tag matches region mapping build tag

3. **Region Mapping → GoReleaser Build** (1:1)
   - One region mapping defines exactly one build configuration
   - Build ID and binary name match region mapping

4. **Embed File → Pricing Data File** (1:1 at build time)
   - Embed file uses `go:embed` to include pricing data file
   - Relationship established at compile time, not runtime

5. **GoReleaser Build → Embed File** (1:1 selection)
   - Build configuration specifies build tag
   - Go build system selects matching embed file
   - Excludes all other embed files

## Data Flow

### Build-Time Data Flow

```text
1. generate-pricing tool
   ↓ writes
2. Pricing Data File (JSON)
   ↓ referenced by
3. Embed File (go:embed directive)
   ↓ selected by
4. GoReleaser Build (build tag)
   ↓ compiles into
5. Binary (embedded pricing data)
```

### Runtime Data Flow

```text
1. Binary starts
   ↓
2. pricing.Client.Init() called
   ↓ sync.Once
3. rawPricingJSON parsed
   ↓
4. pricing.Data indexed (maps for O(1) lookup)
   ↓
5. gRPC GetProjectedCost() called
   ↓
6. pricing.Client.GetEC2Price() or GetEBSPrice()
   ↓ map lookup
7. Return cost to caller
```

## Existing Go Types (No Changes)

The following types from `internal/pricing/types.go` handle all regions (existing + AP):

```go
type PricingData struct {
    Region   string                 `json:"region"`
    Currency string                 `json:"currency"`
    EC2      map[string]EC2Pricing  `json:"ec2"`
    EBS      map[string]EBSPricing  `json:"ebs"`
}

type EC2Pricing struct {
    InstanceType    string  `json:"instance_type"`
    OperatingSystem string  `json:"operating_system"`
    Tenancy         string  `json:"tenancy"`
    HourlyRate      float64 `json:"hourly_rate"`
}

type EBSPricing struct {
    VolumeType     string  `json:"volume_type"`
    RatePerGBMonth float64 `json:"rate_per_gb_month"`
}
```

**Why No Changes Needed**:

- Types are region-agnostic
- JSON unmarshaling handles any region's pricing data
- Map-based lookup supports arbitrary region pricing

## State Transitions

### Binary Lifecycle

```text
[Not Built]
    ↓ goreleaser build -tags region_apse1
[Built - Unstarted]
    ↓ ./finfocus-plugin-aws-public-ap-southeast-1
[Starting]
    ↓ PORT announcement
[Serving gRPC]
    ↓ GetProjectedCost() calls
[Processing Requests]
    ↓ Ctrl+C or SIGTERM
[Shutting Down]
    ↓ context cancellation
[Stopped]
```

### Pricing Data Lifecycle

```text
[Not Generated]
    ↓ generate-pricing --dummy
[Generated JSON]
    ↓ go build (go:embed)
[Embedded in Binary]
    ↓ binary startup
[Parsed to Go Struct]
    ↓ sync.Once (one-time)
[Indexed in Maps]
    ↓ gRPC calls
[Actively Queried]
```

## Validation & Invariants

### Build-Time Invariants

1. **Exactly One Embed**: For any given build tag, exactly one embed file MUST be selected
2. **Pricing File Exists**: Embedded pricing file MUST exist in `internal/pricing/data/`
3. **Valid JSON**: Pricing JSON MUST parse successfully into `PricingData` type
4. **Tag Uniqueness**: No two embed files MAY have the same build tag

### Runtime Invariants

1. **Region Consistency**: `PricingData.Region` MUST match the region binary was built for
2. **Thread Safety**: Pricing lookups MUST be safe for concurrent gRPC calls
3. **No Mutations**: Pricing data maps MUST NOT be modified after initialization
4. **Fast Lookups**: EC2/EBS pricing lookups MUST be O(1) (map access)

### Validation Checklist

For each new AP region, verify:

- [ ] Region Mapping entry exists with all fields
- [ ] Pricing Data File exists in `internal/pricing/data/`
- [ ] Pricing JSON is valid and parseable
- [ ] Embed File has correct build tag
- [ ] Embed File references correct pricing file
- [ ] GoReleaser build configuration exists
- [ ] Build tag matches across all entities
- [ ] Binary name matches convention
- [ ] Fallback embed excludes new region tag

## Summary

The data model for AP region support is **configuration-driven** rather than code-driven:

- **No new Go types** - existing `PricingData`, `EC2Pricing`, `EBSPricing` handle all regions
- **File-based entities** - Region mappings exist as configuration files (embed files, GoReleaser YAML)
- **Build-time relationships** - Entities connected via build tags and file paths
- **Runtime simplicity** - Single pricing client handles all regions identically

This design maintains the constitution's KISS principle while scaling to support 7 regions (3 existing + 4 AP).
